# Week 8 â€” Serverless Image Processing

In this week, we'll focus on Serverless Avatar Image Processing. We'll:

- Create resources for an S3 Bucket where the images will be uploaded.
- A Lambda function triggered on uploading an image to the bucket
- A webhook

## New Directory

Let's contain our CDK pipeline in a new top level directory called `thumbing-serverless-cdk`:

```sh
cd /workspace/aws-bootcamp-cruddur-2023
mkdir thumbing-serverless-cdk
```

## Install CDK globally

AWS Cloud Development Kit (AWS CDK) accelerates cloud development using common programming languages to model your applications. To get more details about AWS CDK Library, look at the (API Reference)[https://docs.aws.amazon.com/cdk/api/v2/docs/aws-construct-library.html].

- We'll install the CDK globally so we can use the AWS CDK CLI from anywhere.

```sh
npm install aws-cdk -g
```

- We'll add the the installation to our gitpod task file:

```sh
  - name: cdk
    before: |
      npm install aws-cdk -g
```

## Initialize a new project

We'll initialize a new CDK project within the folder we created:

```sh
cdk init app --language typescript
```

## Add an S3 Bucket

`thumbing-serverless-cdk/lib/thumbing-serverless-cdk-stack.ts` is where we'll define all of infrastructure code. 
- Add the following code to your `thumbing-serverless-cdk-stack.ts`

```ts
import * as s3 from 'aws-cdk-lib/aws-s3';
...
  constructor(scope: Construct, id: string, props?: cdk.StackProps) {
    ...
    const bucketName: string = process.env.THUMBING_BUCKET_NAME as string;
    const bucket = this.createBucket(bucketName);
  }

  createBucket(bucketName: string): s3.IBucket {
    const bucket = new s3.Bucket(this, 'ThumbingBucket', {
      bucketName: bucketName,
      removalPolicy: cdk.RemovalPolicy.DESTROY
    });
    return bucket;
  }
```
- We can type in `cdk synth` to get the yaml generated by our code.

- Let's create a `thumbing-serverless-cdk/.env` file to store the environment variables. Let's export the bucket name as an environment variable.

```sh
THUMBING_BUCKET_NAME="cruddur-thumbs-171653636382"
```

- To load the environment variable, we add this to the code:

```ts
import * as dotenv from 'dotenv';

dotenv.config();
```

- [Bucket Construct](https://docs.aws.amazon.com/cdk/api/v2/docs/aws-cdk-lib.aws_s3.Bucket.html)
- [Removal Policy](https://docs.aws.amazon.com/cdk/api/v1/docs/@aws-cdk_core.RemovalPolicy.html)

## Bootstrapping

*Bootstrapping* is the process of provisioning resources for the AWS CDK before you can deploy AWS CDK apps into an AWS environment. These resources include an *Amazon S3 bucket* for storing files and *IAM roles* that grant permissions needed to perform deployments.
Bootstrapping the account for the region is required so that AWS knows that AWS resources are provisoned using AWS CDK.

> Deploying stacks with the AWS CDK requires dedicated Amazon S3 buckets and other containers to be available to AWS CloudFormation during deployment. 

```sh
cdk bootstrap "aws://$AWS_ACCOUNT_ID/$AWS_DEFAULT_REGION"
```

![Bootstrapping](https://github.com/awadiagne/aws-bootcamp-cruddur-2023/blob/main/journal/screenshots/Week_8/Bootstrapping.PNG)

## Build

We can use `build` to catch errors prematurely. This just builds typescript.

```sh
npm run build
```

## Synth

> The `cdk synth` command is used to synthesize the AWS CloudFormation stack(s) that represent your infrastructure as code.

```sh
cdk synth
```

## Deploy

`cdk deploy` deploys one or more specified stacks. Let's deploy our stack:

```sh
cdk deploy
```

![S3 Bucket Deployed](https://github.com/awadiagne/aws-bootcamp-cruddur-2023/blob/main/journal/screenshots/Week_8/S3_Bucket_Deployed.PNG)

## List Stacks

```sh
cdk ls
```

![List Stacks](https://github.com/awadiagne/aws-bootcamp-cruddur-2023/blob/main/journal/screenshots/Week_8/List_Stacks.PNG)

## Load Env Vars

- To handle environment variables, we'll install the `dotenv` package by adding it into `thumbing-serverless-cdk/package.json`:

```json
    "dependencies": {
      ...
      "dotenv": "^16.0.3",
    }
```

- We'll then set the environment variables in the `.env` file:

```
THUMBING_BUCKET_NAME='assets.cruddur-app.click'
THUMBING_S3_FOLDER_INPUT='avatars/original'
THUMBING_S3_FOLDER_OUTPUT='avatars/processed'
THUMBING_WEBHOOK_URL="https://api.cruddur-app.click/webhooks/avatars"
THUMBING_TOPIC_NAME="cruddur-assets"
THUMBING_FUNCTION_PATH="/workspace/aws-bootcamp-cruddur-2023/aws/lambdas/process-images"
```


```ts
const dotenv = require('dotenv');
dotenv.config();

const bucketName: string = process.env.THUMBING_BUCKET_NAME as string;
const folderInput: string = process.env.THUMBING_S3_FOLDER_INPUT as string;
const folderOutput: string = process.env.THUMBING_S3_FOLDER_OUTPUT as string;
const webhookUrl: string = process.env.THUMBING_WEBHOOK_URL as string;
const topicName: string = process.env.THUMBING_TOPIC_NAME as string;
const functionPath: string = process.env.THUMBING_FUNCTION_PATH as string;
console.log('bucketName',bucketName)
console.log('folderInput',folderInput)
console.log('folderOutput',folderOutput)
console.log('webhookUrl',webhookUrl)
console.log('topicName',topicName)
console.log('functionPath',functionPath)
```

## Create Bucket

- Let's create the bucket for the avatars:

```ts
import * as s3 from 'aws-cdk-lib/aws-s3';

const bucket = this.createBucket(bucketName)

createBucket(bucketName: string): s3.IBucket {
  const logicalName: string = 'ThumbingBucket';
  const bucket = new s3.Bucket(this, logicalName , {
    bucketName: bucketName,
    removalPolicy: cdk.RemovalPolicy.DESTROY,
  });
  return bucket;
}
```

## Create Lambda

- Now, we create the Lambda function for processing the avatars:
```ts
import * as lambda from 'aws-cdk-lib/aws-lambda';

const lambda = this.createLambda(folderInput, folderOutput, functionPath, bucketName)

createLambda(folderIntput: string, folderOutput: string, functionPath: string, bucketName: string): lambda.IFunction {
  const logicalName = 'ThumbLambda';
  const code = lambda.Code.fromAsset(functionPath)
  const lambdaFunction = new lambda.Function(this, logicalName, {
    runtime: lambda.Runtime.NODEJS_18_X,
    handler: 'index.handler',
    code: code,
    environment: {
      DEST_BUCKET_NAME: bucketName,
      FOLDER_INPUT: folderIntput,
      FOLDER_OUTPUT: folderOutput,
      PROCESS_WIDTH: '512',
      PROCESS_HEIGHT: '512'
    }
  });
  return lambdaFunction;
}
```

## Create Lambda assets

- We'll now create the directory that will hold the files for the Lambda in `aws/lambdas/process-images`:

```
aws/lambdas/process-images
  |_ index.js : holds the handler for the Lambda function
  |_ example.json : a record example
  |_ package.json : the dependencies needed for the Lambda's execution
  |_ s3-image-processing.js : holds the code that processes the image uploaded
  |_ test.js : a script to test the Lambda
```

- The `package.json` file holds the dependencies for the Lambda function. We must install them before deploying the Lambda function:

```sh
cd aws/lambdas/process-images
npm install
```

- Now, we must create a script to do the build and add the dependencies for the Lambda in bin/serverless/build:

```sh
#! /usr/bin/bash

ABS_PATH=$(readlink -f "$0")
SERVERLESS_PATH=$(dirname $ABS_PATH)
BIN_PATH=$(dirname $SERVERLESS_PATH)
PROJECT_PATH=$(dirname $BIN_PATH)
SERVERLESS_PROJECT_PATH="$PROJECT_PATH/thumbing-serverless-cdk"

cd $SERVERLESS_PROJECT_PATH

npm install
rm -rf node_modules/sharp
SHARP_IGNORE_GLOBAL_LIBVIPS=1 npm install --arch=x64 --platform=linux --libc=glibc sharp
```

## Create S3 Event Notification to Lambda

```ts
import * as s3n from 'aws-cdk-lib/aws-s3-notifications';
...

this.createS3NotifyToLambda(folderInput,laombda,bucket)
...
createS3NotifyToLambda(prefix: string, lambda: lambda.IFunction, bucket: s3.IBucket): void {
  const destination = new s3n.LambdaDestination(lambda);
    bucket.addEventNotification(s3.EventType.OBJECT_CREATED_PUT,
    destination,
    { prefix: prefix }
  )
}
```

![S3 Event Notification](https://github.com/awadiagne/aws-bootcamp-cruddur-2023/blob/main/journal/screenshots/Week_8/S3_Event_Notification.PNG)

- Now instead of destroying and recreating the bucket, we'll just import it by name like this:

```ts
  const bucket = this.importBucket(bucketName);
  ...
  importBucket(bucketName: string): s3.IBucket {
    const bucket = s3.Bucket.fromBucketName(this, "AssetsBucket", bucketName);
    return bucket;
  }
```

## Create and Attach to Lambda the Policy for Bucket Access

```ts
const s3ReadWritePolicy = this.createPolicyBucketAccess(bucket.bucketArn);
lambda.addToRolePolicy(s3ReadWritePolicy);
```

## Test the Lambda function

- To test our Lambda, let's put an image into the `original` folder in the bucket. To do so, we can create scripts to create and clear data uploaded in `bin/serverless`:

```
bin/serverless
  |_ clear : Deletes the file data.jpg* from our *assets.cruddur-app.click* bucket
  |_ upload : Uploads a file located in *bin/serverless/files/data.jpg* to our *assets.cruddur-app.click* bucket
```

`bin/serverless/clear`:
```sh
#! /usr/bin/bash

ABS_PATH=$(readlink -f "$0")
SERVERLESS_PATH=$(dirname $ABS_PATH)
DATA_FILE_PATH="$SERVERLESS_PATH/files/data.jpg"

aws s3 rm "s3://assets.$DOMAIN_NAME/avatars/original/data.jpg"
aws s3 rm "s3://assets.$DOMAIN_NAME/avatars/processed/data.jpg"
```

`bin/serverless/upload`:
```sh
#! /usr/bin/bash

ABS_PATH=$(readlink -f "$0")
SERVERLESS_PATH=$(dirname $ABS_PATH)
DATA_FILE_PATH="$SERVERLESS_PATH/files/data.jpg"

aws s3 cp "$DATA_FILE_PATH" "s3://assets.$DOMAIN_NAME/avatars/original/data.jpg"
```

- On running the upload script, we can see that when the `data.jpg` file is put in the bucket, it triggers the Lambda function that processes the picture and creates a new avatar in the same bucket in `avatars/processed`:

![Image Uploaded](https://github.com/awadiagne/aws-bootcamp-cruddur-2023/blob/main/journal/screenshots/Week_8/Image_Uploaded.PNG)

## Create SNS Topic and Susbcription

```ts
import * as subscriptions from 'aws-cdk-lib/aws-sns-subscriptions';
import * as sns from 'aws-cdk-lib/aws-sns';
...
const snsTopic = this.createSnsTopic(topicName);
this.createSnsSubscription(snsTopic,webhookUrl);
...
createSnsTopic(topicName: string): sns.ITopic{
  const logicalName = "Topic";
  const snsTopic = new sns.Topic(this, logicalName, {
    topicName: topicName
  });
  return snsTopic;
}

createSnsSubscription(snsTopic: sns.ITopic, webhookUrl: string): sns.Subscription {
  const snsSubscription = snsTopic.addSubscription(
    new subscriptions.UrlSubscription(webhookUrl)
  )
  return snsSubscription;
}
```

## Using CloudFront as CDN for the images

Amazon CloudFront is a fast content delivery network (CDN) service that securely delivers data, videos, applications, and APIs to customers globally with low latency, high transfer speeds, all within a developer-friendly environment. CloudFront offers a cache to improve latency and lower the load on your origin servers.

Let's create a CloudFront distribution that points to our S3 bucket in the console. Then, we'll update the bucket policy to make it accessible from CloudFront.

### Create separate buckets for the uploaded images and the avatars 

```ts
const uploadsBucketName: string = process.env.UPLOADS_BUCKET_NAME as string;
const assetsBucketName: string = process.env.ASSETS_BUCKET_NAME as string;
...
const uploadsBucket = this.createBucket(uploadsBucketName);
const assetsBucket = this.importBucket(assetsBucketName);
const lambda = this.createLambda(folderInput, folderOutput, functionPath, assetsBucketName);

// Create and Attach policies for S3 access
const s3ReadWritePolicyForUploads = this.createPolicyBucketAccess(uploadsBucket.bucketArn)
const s3ReadWritePolicyForAssets = this.createPolicyBucketAccess(assetsBucket.bucketArn)
lambda.addToRolePolicy(s3ReadWritePolicyForUploads);
lambda.addToRolePolicy(s3ReadWritePolicyForAssets);

// Add our s3 event notifications
this.createS3NotifyToLambda(folderInput, lambda, uploadsBucket);
```

## Implement User Edit Page

## Create show.sql

- We first create a SQL request to fetch the user's profile details:
backend-flask/db/sql/users/show.sql:

```sql
SELECT 
  (SELECT COALESCE(row_to_json(object_row),'{}'::json) FROM (
    SELECT
      users.uuid,
      users.handle,
      users.display_name,
      (
       SELECT 
        count(true) 
       FROM public.activities
       WHERE
        activities.user_uuid = users.uuid
       ) as cruds_count
  ) object_row) as profile,
  (SELECT COALESCE(array_to_json(array_agg(row_to_json(array_row))),'[]'::json) FROM (
    SELECT
      activities.uuid,
      users.display_name,
      users.handle,
      activities.message,
      activities.created_at,
      activities.expires_at
    FROM public.activities
    WHERE
      activities.user_uuid = users.uuid
    ORDER BY activities.created_at DESC 
    LIMIT 40
  ) array_row) as activities
FROM public.users
WHERE
  users.handle = %(handle)s
```
- We then use those details to map them into the user profile and his activity feed:
backend-flask/services/user_activities:
```py
if user_handle == None or len(user_handle) < 1:
      model['errors'] = ['blank_user_handle']
    else:
      print("else:")
      sql = db.template('users','show')
      results = db.query_object_json(sql,{'handle': user_handle})
      model['data'] = results
```

- Here, we display the profile header with the banner image, the avatar and Edit Profile button:
```js
import './ProfileHeading.css';
import EditProfileButton from '../components/EditProfileButton';

export default function ProfileHeading(props) {
  const backgroundImage = 'url("https://assets.cruddur.com/banners/banner.jpg")';
  const styles = {
    backgroundImage: backgroundImage,
    backgroundSize: 'cover',
    backgroundPosition: 'center',
  };
  return (
  <div className='activity_feed_heading profile_heading'>
    <div className='title'>{props.profile.display_name}</div>
    <div className="cruds_count">{props.profile.cruds_count} Cruds</div>
    <div class="banner" style={styles} >
      <div className="avatar">
        <img src="https://assets.cruddur.com/avatars/data.jpg"></img>
      </div>
    </div>
    <div class="info">
      <div class='id'>
        <div className="display_name">{props.profile.display_name}</div>
        <div className="handle">@{props.profile.handle}</div>
      </div>
      <EditProfileButton setPopped={props.setPopped} />
    </div>

  </div>
  );
}
```

## Create the API Gateway

We need to generate a pre-signed URL after authentication to an API endpoint. Then, we'll use it to post the avatar we want to upload. To do so, we'll need an API Gateway.

Amazon API Gateway is a fully managed service that makes it easy for developers to create, publish, maintain, monitor, and secure APIs at any scale. 

- We'll also create the Lambda and grant it the right permissions. The code for the Lambda is in `aws/lambdas/cruddur-upload-avatar/function.rb` and the policy in `aws/lambdas/policies/s3-upload-avatar-presigned-url-policy.json`.

- We'll need to import JWT into the Lambda environment. We create the `aws/lambdas/lambda-authorizer` folder and import the JWT package into the package.json. After running `npm i`, we'll have the `node-modules` folder and `package-lock.json`. We also create `index.js` inside the new folder to implement the use of JWT.

- Now, we create a new Lambda function called `CruddurLambdaAuthorizer` where we upload the zipped version of the Lambda authorizer with JWT code.

- Now, we can create the API on Amazon API Gateway. Let's go for an HTTP API

![Create API](https://github.com/awadiagne/aws-bootcamp-cruddur-2023/blob/main/journal/screenshots/Week_8/Create_API.PNG)

![Config Routes](https://github.com/awadiagne/aws-bootcamp-cruddur-2023/blob/main/journal/screenshots/Week_8/Config_Routes.PNG)

- Then, we can attach the authorizer:

![Attach Authorizer](https://github.com/awadiagne/aws-bootcamp-cruddur-2023/blob/main/journal/screenshots/Week_8/Attach_Authorizer.PNG)